/*
 * Copyright (C) 2020 Cognibotics
 *
 * Use or copying of this file or any part of it, without explicit
 * permission from Cognibotics is not allowed in any way.
 */
#include <assert.h>
#include <math.h>
#include <string.h>
#include <stdio.h>
#include <time.h>

#include "lin_alg.h"

#define NBR_ITE 100000


static void test_inv22()
{
	double mat1[2][2] = {
		{1.0, 0.0},
		{0.0, 0.5}};
	double res1_true[2][2] = {
		{1.0, 0.0},
		{0.0, 2.0}};
	double mat2[2][2] = {
		{1.0, 2.0},
		{3.0, 4.0}};
	double res2_true[2][2] = {
		{-2.0, 1.0},
		{1.5, -0.5}};
	double mat3[2][2] = {
		{1.0, 2.0},
		{2.0, 4.0}};
	double res[2][2];
	int ret;

	/* First test solution to invertible systems */
	ret = inv_22(mat1, res);
	assert(ret == 0);
	printf("\nres1:\n");
	for (int i1 = 0; i1 < 2; i1++) {
		for (int i2 = 0; i2 < 2; i2++) {
			printf("%f  ", res[i1][i2]);
			assert(fabs(res[i1][i2] - res1_true[i1][i2])  < 1e-10);
		}
		printf("\n");
	}
	printf("\n");

	ret = inv_22(mat2, res);
	assert(ret == 0);
	printf("\nres2:\n");
	for (int i1 = 0; i1 < 2; i1++) {
		for (int i2 = 0; i2 < 2; i2++) {
			printf("%f  ", res[i1][i2]);
			assert(fabs(res[i1][i2] - res2_true[i1][i2])  < 1e-10);
		}
		printf("\n");
	}
	printf("\n");

	/* Try a singular system */
	ret = inv_22(mat3, res);
	assert(ret == 1);
}


static void test_inv33()
{
	double mat1[3][3] = {
		{1.0, 0.0, 0.0},
		{0.0, 0.5, 0.0},
		{0.0, 0.0, 0.25}};
	double res1_true[3][3] = {
		{1.0, 0.0, 0.0},
		{0.0, 2.0, 0.0},
		{0.0, 0.0, 4.0}};
	double mat2[3][3] = {
		{1.0, 2.0, 3.0},
		{4.0, 5.0, 7.0},
		{6.0, 8.0, 9.0}};
	double res2_true[3][3] = {
		{-1.5714285714285714, 0.8571428571428573, -0.14285714285714293},
		{0.8571428571428573, -1.2857142857142863, 0.7142857142857145},
		{0.2857142857142856, 0.5714285714285717, -0.4285714285714287}};
	double mat3[3][3] = {
		{1.0, 2.0, 3.0},
		{4.0, 5.0, 6.0},
		{7.0, 8.0, 9.0}};
	double res[3][3];
	int ret;

	/* First test solution to invertible systems */
	ret = inv_33(mat1, res);
	assert(ret == 0);
	printf("\nres1:\n");
	for (int i1 = 0; i1 < 3; i1++) {
		for (int i2 = 0; i2 < 3; i2++) {
			printf("%f  ", res[i1][i2]);
			assert(fabs(res[i1][i2] - res1_true[i1][i2])  < 1e-10);
		}
		printf("\n");
	}
	printf("\n");

	ret = inv_33(mat2, res);
	assert(ret == 0);
	printf("\nres2:\n");
	for (int i1 = 0; i1 < 3; i1++) {
		for (int i2 = 0; i2 < 3; i2++) {
			printf("%f  ", res[i1][i2]);
			assert(fabs(res[i1][i2] - res2_true[i1][i2])  < 1e-10);
		}
		printf("\n");
	}
	printf("\n");

	/* Try a singular system */
	ret = inv_33(mat3, res);
	assert(ret == 1);
}


static void test_solve_33_3(void)
{
	double mat1[3][3] = {
		{1.0, 0.0, 0.0},
		{0.0, 0.5, 0.0},
		{0.0, 0.0, 0.25}};
	double res1_true[3] = {1.0, 2.0, 4.0};
	double mat2[3][3] = {
		{1.0, 0.0, 0.0},
		{0.0, 0.0, 0.0},
		{0.0, 0.0, 1.0}};
	double res2_true[3] = {0.9999900000999989, 0.0, 0.9999900000999989};
	double vec[3] = {1.0, 1.0, 1.0};
	double res[3];
	int ret;

	/* First test solution to invertible system */
	ret = solve_33_3(mat1, vec, res);
	assert(ret == 0);
	printf("\nres1:\n");
	for (int i1 = 0; i1 < 3; i1++) {
		printf("%f  ", res[i1]);
		assert(fabs(res[i1] - res1_true[i1])  < 1e-10);
	}
	printf("\n");

	/* Try solving a singular system */
	ret = solve_33_3(mat2, vec, res);
	assert(ret == 0);
	printf("\nres2:\n");
	for (int i1 = 0; i1 < 3; i1++) {
		printf("%f  ", res[i1]);
		assert(fabs(res[i1] - res2_true[i1])  < 1e-10);
	}
	printf("\n");
}


static void test_solve_22_2(void)
{
	double mat1[2][2] = {
		{1.0, 0.0},
		{0.0, 0.5}};
	double res1_true[2] = {1.0, 2.0};
	double mat2[2][2] = {
		{1.0, 0.0},
		{0.0, 0.0}};
	double res2_true[2] = {0.9999900000999989, 0.0};
	double vec[2] = {1.0, 1.0};
	double res[2];
	int ret;

	/* First test solution to invertible system */
	ret = solve_22_2(mat1, vec, res);
	assert(ret == 0);
	printf("\nres1:\n");
	for (int i1 = 0; i1 < 2; i1++) {
		printf("%f  ", res[i1]);
		assert(fabs(res[i1] - res1_true[i1])  < 1e-10);
	}
	printf("\n");

	/* Try solving a singular system */
	ret = solve_22_2(mat2, vec, res);
	assert(ret == 0);
	printf("\nres2:\n");
	for (int i1 = 0; i1 < 2; i1++) {
		printf("%f  ", res[i1]);
		assert(fabs(res[i1] - res2_true[i1])  < 1e-10);
	}
	printf("\n");
}


static void test_determinant(void)
{
	double mat1[6][6] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 1.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 1.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 1.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 1.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 1.0}};
	double det1 = 1.0;
	double mat2[6][6] = {
		{1.0, 2.0, 3.0, 4.0, 5.0, 6.0},
		{2.0, 3.0, 4.0, 5.0, 6.0, 1.0},
		{3.0, 4.0, 5.0, 6.0, 1.0, 2.0},
		{4.0, 5.0, 6.0, 1.0, 2.0, 3.0},
		{5.0, 6.0, 1.0, 2.0, 3.0, 4.0},
		{6.0, 1.0, 2.0, 3.0, 4.0, 5.0}};
	double det2 = -27216.0;
	double mat3[6][6] = {
		{-0.7, 2.4, -3.2, -3.0, -1.1, 4.6},
		{3.6, -4.2, 4.9, 4.3, 2.8, -0.9},
		{-4.4, 0.2, -0.4, 3.1, -5.0, -3.7},
		{-2.2, -1.2, -3.0, -3.2, 0.1, -1.7},
		{-4.6, 1.5, -0.6, -3.4, 4.7, 2.3},
		{-1.9, -2.1, 1.8, -4.8, 4.4, -3.0}};
	double det3 = -11847.948065;
	double mat4[6][6] = {
		{-0.0054447174, 3.990977301, 8.9775294348, 0.9870211222, 1.0316597068, 7.0309854553},
		{2.9752977831, 4.9590647864, 7.8980529678, 8.9411159414, 7.1436373814, 4.1405783601},
		{8.0080280817, 9.0133037144, 4.0331322127, 5.0191369882, 6.953318658, 1.9543128228},
		{4.0013511289, 8.0022390197, 1.0055761627, 8.0032207616, 5.9921435142, 0.9923108325},
		{2.0283641315, 4.0470035457, 8.1170598993, 8.0676131695, 5.8350694763, 4.8385819742},
		{7.9932741672, 7.9888543039, 2.9722422204, 7.9839672555, 7.0391090814, 2.0382761818}};
	double det4 = 6.691891e-08;
	double det;
	double start, stop, t1;

	det = determinant_66(mat1);
	printf("\n\nDeterminant1: %f\n", det);
	assert(fabs(det-det1) < 1e-10);

	det = determinant_66(mat2);
	printf("\nDeterminant2: %f\n", det);
	assert(fabs(det-det2) < 1e-10);

	det = determinant_66(mat3);
	printf("\nDeterminant3: %f\n", det);
	assert(fabs(det-det3) < 1e-10);

	det = determinant_66(mat4);
	printf("\nDeterminant4: %f\n", det);
	assert(fabs(det-det4) < 1e-10);

	start = clock();
	for (int i = 0; i < NBR_ITE; ++i) {
		det = determinant_66(mat4);
	}
	stop = clock();
	t1 = (double)(stop-start)/CLOCKS_PER_SEC/NBR_ITE*1e6;
	printf("\n%d iterations of determinant calc: %f microsec per call\n",
			NBR_ITE, t1);
}


static void test_solve_66_gauss_elim(void)
{
	double mat1[6][6] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 1.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 1.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 1.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 1.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 1.0}};
	double y1[6] = {1.0, 2.0, 3.0, 4.0, 5.0, 6.0};
	double mat2[6][6] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 2.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 3.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 4.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 5.0, 0.0},
{0.0, 0.0, 0.0, 0.0, 0.0, 6.0}};
	double mat3[6][6] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 1.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 1.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 1.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 1.0}};
	double mat4[6][6] = {
		{1.0, 2.0, 3.0, 4.0, 5.0, 6.0},
		{2.0, 1.0, 0.0, 3.0, 4.0, 1.0},
		{3.0, 0.0, 0.0, 2.0, 2.0, 2.0},
		{4.0, 1.0, 4.0, 1.0, 4.0, 1.0},
		{-0.3, 2.0, -1.0, 10.0, 0.4, 0.5},
		{1.0, 0.9, 0.8, 0.7, 0.6, 0.5}};
	double sol4[6] = {2.628463302118725, 6.570509101958512,
			-1.2108229054446014, -0.7931825087704765,
			-1.93279191182564, 0.2832794674180271};
	double mat5[6][6] = {
		{1.0, 2.0, 3.0, 4.0, 5.0, 6.0},
		{2.0, 1.0, 0.0, 3.0, 10.0, 1.0},
		{3.0, 0.0, 0.0, 2.0, 15.0, 2.0},
		{4.0, 1.0, 4.0, 1.0, 20.0, 1.0},
		{-0.3, 2.0, -1.0, 10.0, -1.5, 0.5},
		{1.0, 0.9, 0.8, 0.7, 5.0, 0.5}};
	double mat6[6][6] = {
		{ 0.0, -0.412, -1.092,  0.0,   -1.302,  0.0},
		{ 0.0,  0.0,    0.0,   -1.302,  0.0,   -1.302},
		{ 0.0,  0.16,   0.16,  -0.0,    0.9,   -0.0},
		{ 0.0,  0.0,    0.0,   -1.0,    0.0,   -1.0},
		{ 0.0,  1.0,    1.0,    0.0,    1.0,    0.0},
		{-1.0,  0.0,    0.0,    0.0,    0.0,    0.0}};
	double sol[6];
	int ret;
	double start, stop, t1;

	ret = solve_66_gauss_elim(mat1, y1, sol);
	printf("\n\nTest1\nret: %d\n", ret);
	assert(ret == SOLUTION_OK);
	printf("sol: ");
	for (int i = 0; i < 6; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - y1[i]) < 1e-10);
	}
	printf("\n");

	ret = solve_66_gauss_elim(mat2, y1, sol);
	printf("\nTest2\nret: %d\n", ret);
	assert(ret == SOLUTION_OK);
	printf("sol: ");
	for (int i = 0; i < 6; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - 1) < 1e-10);
	}
	printf("\n");

	ret = solve_66_gauss_elim(mat3, y1, sol);
	printf("\nTest3\nret: %d\n", ret);
	assert(ret == SINGULAR_SYSTEM);

	ret = solve_66_gauss_elim(mat4, y1, sol);
	printf("\nTest4\nret: %d\n", ret);
	assert(ret == SOLUTION_OK);
	printf("sol: ");
	for (int i = 0; i < 6; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - sol4[i]) < 1e-10);
	}
	printf("\n");

	ret = solve_66_gauss_elim(mat5, y1, sol);
	printf("\nTest5\nret: %d\n", ret);
	assert(ret == SINGULAR_SYSTEM);

	printf("\n");

	ret = solve_66_gauss_elim(mat6, y1, sol);
	printf("\nTest6\nret: %d\n", ret);
	assert(ret == SINGULAR_SYSTEM);

	start = clock();
	for (int i = 0; i < NBR_ITE; ++i) {
		ret = solve_66_gauss_elim(mat4, y1, sol);
	}
	stop = clock();
	t1 = (double)(stop-start)/CLOCKS_PER_SEC/NBR_ITE*1e6;
	printf("\n%d iterations of solve_66_gauss_elim: %f microsec per call\n",
			NBR_ITE, t1);
}


static void test_solve_66_6_damped_ls(void)
{
	double mat1[6][6] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 1.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 1.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 1.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 1.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 1.0}};
	double y1[6] = {1.0, 2.0, 3.0, 4.0, 5.0, 6.0};
	double mat2[6][6] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 2.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 3.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 4.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 5.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 6.0}};
	double mat3[6][6] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 1.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 1.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 1.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 1.0}};
	double sol3[6] = {0.9999900001, 1.9999800002, 2.9999700003,
			3.9999600004, 0.0, 5.9999400006};
	double mat4[6][6] = {
		{1.0, 2.0, 3.0, 4.0, 5.0, 6.0},
		{2.0, 1.0, 0.0, 3.0, 4.0, 1.0},
		{3.0, 0.0, 0.0, 2.0, 2.0, 2.0},
		{4.0, 1.0, 4.0, 1.0, 4.0, 1.0},
		{-0.3, 2.0, -1.0, 10.0, 0.4, 0.5},
		{1.0, 0.9, 0.8, 0.7, 0.6, 0.5}};
	double sol4[6] = {2.628463302118725, 6.570509101958512,
			-1.2108229054446014, -0.7931825087704765,
			-1.93279191182564, 0.2832794674180271};
	double mat5[6][6] = {
		{1.0, 2.0, 3.0, 4.0, 5.0, 6.0},
		{2.0, 1.0, 0.0, 3.0, 10.0, 1.0},
		{3.0, 0.0, 0.0, 2.0, 15.0, 2.0},
		{4.0, 1.0, 4.0, 1.0, 20.0, 1.0},
		{-0.3, 2.0, -1.0, 10.0, -1.5, 0.5},
		{1.0, 0.9, 0.8, 0.7, 5.0, 0.5}};
	double sol5[6] = {0.5943020815680102, 3.7275056388567718,
			-0.8244898217951435,  -0.3051148384182103,
			0.11886041631235134, -0.622311005162515};
	double sol[6];
	int ret;

	ret = solve_66_6_damped_ls(mat1, y1, 0.0, sol);
	printf("\n\nTest1\nret: %d\n", ret);
	assert(ret == SOLUTION_OK);
	printf("sol: ");
	for (int i = 0; i < 6; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - y1[i]) < 1e-10);
	}
	printf("\n");

	ret = solve_66_6_damped_ls(mat2, y1, 0.0, sol);
	printf("\nTest2\nret: %d\n", ret);
	assert(ret == SOLUTION_OK);
	printf("sol: ");
	for (int i = 0; i < 6; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - 1) < 1e-10);
	}
	printf("\n");

	ret = solve_66_6_damped_ls(mat3, y1, 0.0, sol);
	printf("\nTest3\nret: %d\n", ret);
	assert(ret == SINGULAR_SYSTEM);
	ret = solve_66_6_damped_ls(mat3, y1, 0.00001, sol);
	printf("\nlambda=0.00001\nret: %d\n", ret);
	assert(ret != SINGULAR_SYSTEM);
	printf("sol: ");
	for (int i = 0; i < 6; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - sol3[i]) < 1e-10);
	}
	printf("\n");

	ret = solve_66_6_damped_ls(mat4, y1, 0.0, sol);
	printf("\nTest4\nret: %d\n", ret);
	assert(ret == SOLUTION_OK);
	printf("sol: ");
	for (int i = 0; i < 6; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - sol4[i]) < 1e-10);
	}
	printf("\n");

	ret = solve_66_6_damped_ls(mat5, y1, 0.0, sol);
	printf("\nTest5\nret: %d\n", ret);
	assert(ret == SINGULAR_SYSTEM);
	ret = solve_66_6_damped_ls(mat5, y1, 0.00001, sol);
	printf("\nlambda=0.00001\nret: %d\n", ret);
	assert(ret != SINGULAR_SYSTEM);
	printf("sol: ");
	for (int i = 0; i < 6; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - sol5[i]) < 1e-10);
	}
	printf("\n");
}


static void test_solve_12x12_gauss_elim(void)
{
	double mat1[12][12] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0}};
	double y1[12] = {1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0};
	double mat11[12][12] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0}};
	double mat2[12][12] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 2.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 3.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 4.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 6.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 7.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 8.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 9.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 10.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 11.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 12.0}};
	double mat3[12][12] = {
		{2.0, 2.0, 2.0, 8.0, 3.0, 4.0, 8.0, 1.0, 1.0, 1.0, 7.0, 3.0},
		{2.0, 8.0, 4.0, 4.0, 1.0, 4.0, 2.0, 5.0, 1.0, 1.0, 5.0, 4.0},
		{0.0, 5.0, 7.0, 4.0, 6.0, 8.0, 8.0, 5.0, 5.0, 5.0, 8.0, 0.0},
		{4.0, 6.0, 1.0, 0.0, 1.0, 4.0, 8.0, 0.0, 4.0, 4.0, 2.0, 3.0},
		{8.0, 4.0, 7.0, 7.0, 7.0, 4.0, 3.0, 5.0, 2.0, 1.0, 5.0, 5.0},
		{7.0, 5.0, 2.0, 8.0, 5.0, 6.0, 3.0, 4.0, 3.0, 5.0, 6.0, 6.0},
		{7.0, 0.0, 1.0, 4.0, 2.0, 2.0, 8.0, 6.0, 8.0, 3.0, 0.0, 0.0},
		{0.0, 1.0, 5.0, 5.0, 8.0, 0.0, 5.0, 4.0, 4.0, 6.0, 7.0, 3.0},
		{0.0, 8.0, 2.0, 3.0, 1.0, 2.0, 7.0, 4.0, 1.0, 8.0, 1.0, 5.0},
		{0.0, 8.0, 8.0, 4.0, 8.0, 4.0, 4.0, 5.0, 4.0, 4.0, 5.0, 8.0},
		{1.0, 7.0, 0.0, 5.0, 2.0, 8.0, 1.0, 7.0, 2.0, 5.0, 3.0, 8.0},
		{4.0, 3.0, 8.0, 7.0, 6.0, 8.0, 3.0, 5.0, 2.0, 8.0, 8.0, 5.0}};
	double sol3[12] = {-0.01501106064808505, -0.9960070804575728, 0.4579819639746357,
			-0.5182923364491807, -0.4368833382423403, 0.06477691175342955,
			0.23413749766270314, 0.6981267879973129, 0.15235392444083257,
			0.7279285181747802, -0.10184129983468912, 1.5217777668323553};

	double sol[12];
	int ret;
	double start, stop, t1;

	printf("\n\nTest solve_12x12_gauss_elim\n");
	ret = solve_12x12_gauss_elim(mat1, y1, sol);
	printf("\nTest1\nret: %d\n", ret);
	assert(ret == 0);
	printf("sol: ");
	for (int i = 0; i < 12; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - y1[i]) < 1e-10);
	}
	printf("\n");

	ret = solve_12x12_gauss_elim(mat11, y1, sol);
	printf("\nTest11\nret: %d\n", ret);
	assert(ret == 1);
	printf("\n");

	ret = solve_12x12_gauss_elim(mat2, y1, sol);
	printf("\nTest2\nret: %d\n", ret);
	assert(ret == 0);
	printf("sol: ");
	for (int i = 0; i < 12; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - 1) < 1e-10);
	}
	printf("\n");

	ret = solve_12x12_gauss_elim(mat3, y1, sol);
	printf("\nTest3\nret: %d\n", ret);
	assert(ret == 0);
	printf("sol: ");
	for (int i = 0; i < 12; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - sol3[i]) < 1e-10);
	}
	printf("\n");

	start = clock();
	for (int i = 0; i < NBR_ITE; ++i) {
		ret = solve_12x12_gauss_elim(mat3, y1, sol);
	}
	stop = clock();
	t1 = (double)(stop-start)/CLOCKS_PER_SEC/NBR_ITE*1e6;
	printf("\n%d iterations of solve_12x12_gauss_elim: %f microsec per call\n",
			NBR_ITE, t1);
}


static void test_solve_12x12_12_damped_ls(void)
{
	double mat1[12][12] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0}};
	double y1[12] = {1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0};
	double mat11[12][12] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0}};
	double sol11[12] = {0.9999900000999989, 1.9999800001999979, 2.9999700002999967,
			3.9999600003999958, 4.999950000499995, 5.999940000599993,
			6.999930000699993, 7.9999200007999915, 8.999910000899991,
			9.99990000099999, 0.0, 11.999880001199987};
	double mat2[12][12] = {
		{1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 2.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 3.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 4.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 6.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 7.0, 0.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 8.0, 0.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 9.0, 0.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 10.0, 0.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 11.0, 0.0},
		{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 12.0}};
	double mat3[12][12] = {
		{2.0, 2.0, 2.0, 8.0, 3.0, 4.0, 8.0, 1.0, 1.0, 1.0, 7.0, 3.0},
		{2.0, 8.0, 4.0, 4.0, 1.0, 4.0, 2.0, 5.0, 1.0, 1.0, 5.0, 4.0},
		{0.0, 5.0, 7.0, 4.0, 6.0, 8.0, 8.0, 5.0, 5.0, 5.0, 8.0, 0.0},
		{4.0, 6.0, 1.0, 0.0, 1.0, 4.0, 8.0, 0.0, 4.0, 4.0, 2.0, 3.0},
		{8.0, 4.0, 7.0, 7.0, 7.0, 4.0, 3.0, 5.0, 2.0, 1.0, 5.0, 5.0},
		{7.0, 5.0, 2.0, 8.0, 5.0, 6.0, 3.0, 4.0, 3.0, 5.0, 6.0, 6.0},
		{7.0, 0.0, 1.0, 4.0, 2.0, 2.0, 8.0, 6.0, 8.0, 3.0, 0.0, 0.0},
		{0.0, 1.0, 5.0, 5.0, 8.0, 0.0, 5.0, 4.0, 4.0, 6.0, 7.0, 3.0},
		{0.0, 8.0, 2.0, 3.0, 1.0, 2.0, 7.0, 4.0, 1.0, 8.0, 1.0, 5.0},
		{0.0, 8.0, 8.0, 4.0, 8.0, 4.0, 4.0, 5.0, 4.0, 4.0, 5.0, 8.0},
		{1.0, 7.0, 0.0, 5.0, 2.0, 8.0, 1.0, 7.0, 2.0, 5.0, 3.0, 8.0},
		{4.0, 3.0, 8.0, 7.0, 6.0, 8.0, 3.0, 5.0, 2.0, 8.0, 8.0, 5.0}};
	double sol3[12] = {-0.01501106064808505, -0.9960070804575728, 0.4579819639746357,
			-0.5182923364491807, -0.4368833382423403, 0.06477691175342955,
			0.23413749766270314, 0.6981267879973129, 0.15235392444083257,
			0.7279285181747802, -0.10184129983468912, 1.5217777668323553};
	double sol31[12] = {-0.015325964146125082, -0.9950102767551892, 0.45799835163691927,
			-0.5168478731211807, -0.43649543116122924, 0.06483000991762478,
			0.2334801802712103, 0.6971475323726426, 0.15306677297566385,
			0.7281674773155687, -0.10271128122851159, 1.5206884614289926};

	double sol[12];
	int ret;
	double start, stop, t1;

	printf("\n\nTest solve_12x12_12_damped_ls\n");
	ret = solve_12x12_12_damped_ls(mat1, y1, 0.0, sol);
	printf("\nTest1\nret: %d\n", ret);
	assert(ret == 0);
	printf("sol: ");
	for (int i = 0; i < 12; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - y1[i]) < 1e-10);
	}
	printf("\n");

	ret = solve_12x12_12_damped_ls(mat11, y1, 0.0, sol);
	printf("\nTest11\nret: %d\n", ret);
	assert(ret == 1);
	printf("\n");
	ret = solve_12x12_12_damped_ls(mat11, y1, 0.00001, sol);
	printf("\nTest11\nret: %d\n", ret);
	assert(ret == 0);
	printf("sol: ");
	for (int i = 0; i < 12; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - sol11[i]) < 1e-10);
	}
	printf("\n");

	ret = solve_12x12_12_damped_ls(mat2, y1, 0.0, sol);
	printf("\nTest2\nret: %d\n", ret);
	assert(ret == 0);
	printf("sol: ");
	for (int i = 0; i < 12; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - 1) < 1e-10);
	}
	printf("\n");

	ret = solve_12x12_12_damped_ls(mat3, y1, 0.0, sol);
	printf("\nTest3\nret: %d\n", ret);
	assert(ret == 0);
	printf("sol: ");
	for (int i = 0; i < 12; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - sol3[i]) < 1e-10);
	}
	printf("\n");

	ret = solve_12x12_12_damped_ls(mat3, y1, 0.00001, sol);
	printf("\nTest31\nret: %d\n", ret);
	assert(ret == 0);
	printf("sol: ");
	for (int i = 0; i < 12; i++) {
		printf("%f ", sol[i]);
		assert(fabs(sol[i] - sol31[i]) < 1e-10);
	}
	printf("\n");

	start = clock();
	for (int i = 0; i < NBR_ITE; ++i) {
		ret = solve_12x12_12_damped_ls(mat3, y1, 0.00001, sol);
	}
	stop = clock();
	t1 = (double)(stop-start)/CLOCKS_PER_SEC/NBR_ITE*1e6;
	printf("\n%d iterations of solve_12x12_12_damped_ls: %f microsec per call\n",
			NBR_ITE, t1);
}


int main(void)
{
	test_inv22();
	test_inv33();
	test_solve_33_3();
	test_solve_22_2();
	test_determinant();
	test_solve_66_gauss_elim();
	test_solve_66_6_damped_ls();
	test_solve_12x12_gauss_elim();
	test_solve_12x12_12_damped_ls();
}

